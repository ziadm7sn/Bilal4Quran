<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث في القرآن الكريم</title>
    <style>
        /* استيراد خطوط Google للعربية */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap');

        /* متغيرات CSS للألوان والقيم */
        :root {
            --primary-color: #2c3e50;
            --primary-light: #34495e;
            --secondary-color: #3498db;
            --secondary-light: #5dade2;
            --accent-color: #e74c3c;
            --accent-light: #ec7063;
            --success-color: #27ae60;
            --success-light: #58d68d;
            --warning-color: #f39c12;
            --warning-light: #f8c471;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --background-light: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-light: #bdc3c7;
            --border-color: #e9ecef;
            --border-radius: 12px;
            --border-radius-small: 8px;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.2);
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Arabic', 'Arial', sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            backdrop-filter: blur(10px);
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .header h1 {
            font-family: 'Amiri', serif;
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 0.9;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .search-section {
            padding: 40px 30px;
            background: var(--background-light);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .search-container {
            display: flex;
            gap: 15px;
            max-width: 700px;
            margin: 0 auto 30px;
            position: relative;
        }

        .search-input {
            flex: 1;
            padding: 18px 25px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            font-size: 16px;
            font-family: 'Noto Sans Arabic', sans-serif;
            outline: none;
            transition: var(--transition-medium);
            background: white;
            box-shadow: var(--shadow-light);
        }

        .search-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1), var(--shadow-medium);
            transform: translateY(-2px);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        .search-btn {
            padding: 18px 35px;
            background: linear-gradient(135deg, var(--success-color), var(--success-light));
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Noto Sans Arabic', sans-serif;
            cursor: pointer;
            transition: var(--transition-medium);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .search-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-medium);
        }

        .search-btn:hover::before {
            left: 100%;
        }

        .search-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }

        .search-btn:active {
            transform: translateY(-1px);
        }

        .search-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-light);
        }

        .search-btn:disabled::before {
            display: none;
        }

        .results-section {
            padding: 40px 30px;
        }

        .loading {
            text-align: center;
            padding: 60px 40px;
            font-size: 18px;
            color: var(--text-secondary);
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots {
            display: inline-block;
            animation: loadingDots 1.5s infinite;
        }

        @keyframes loadingDots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 25px;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 20px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .results-table th:first-child {
            border-top-left-radius: var(--border-radius);
        }

        .results-table th:last-child {
            border-top-right-radius: var(--border-radius);
        }

        .results-table td {
            padding: 25px 20px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
            transition: var(--transition-fast);
        }

        .results-table tr:hover {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .results-table tr:last-child td:first-child {
            border-bottom-left-radius: var(--border-radius);
        }

        .results-table tr:last-child td:last-child {
            border-bottom-right-radius: var(--border-radius);
        }

        .verse-text {
            font-family: 'Amiri', serif;
            font-size: 19px;
            line-height: 2;
            color: var(--text-primary);
            text-align: justify;
            font-weight: 400;
            direction: rtl;
        }

        .no-results {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-secondary);
            font-size: 18px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin: 20px 0;
        }

        .no-results::before {
            content: '🔍';
            display: block;
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .error-message {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
            box-shadow: var(--shadow-medium);
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .translation-cell {
            font-size: 14px;
            line-height: 1.6;
            padding: 20px !important;
            vertical-align: top;
            border-right: 1px solid var(--border-color);
            position: relative;
        }

        .loading-spinner {
            color: var(--secondary-color);
            font-style: italic;
            text-align: center;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loading-spinner::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .translation-text {
            direction: ltr;
            text-align: left;
            font-family: 'Times New Roman', serif;
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 14px;
        }

        .translation-error {
            color: var(--accent-color);
            font-style: italic;
            text-align: center;
            padding: 10px;
            border-radius: var(--border-radius-small);
            background: rgba(231, 76, 60, 0.1);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .translation-error:hover {
            background: rgba(231, 76, 60, 0.2);
            transform: scale(1.02);
        }

        .translation-unavailable {
            color: var(--warning-color);
            font-style: italic;
            text-align: center;
            padding: 10px;
            border-radius: var(--border-radius-small);
            background: rgba(243, 156, 18, 0.1);
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .pagination-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-light));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius-small);
            font-size: 14px;
            font-weight: 500;
            font-family: 'Noto Sans Arabic', sans-serif;
            cursor: pointer;
            transition: var(--transition-medium);
            min-width: 100px;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .pagination-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-medium);
        }

        .pagination-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .pagination-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--secondary-light), var(--secondary-color));
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .pagination-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-light);
            opacity: 0.6;
        }

        .pagination-btn:disabled::before {
            display: none;
        }

        .pagination-btn:active:not(:disabled) {
            transform: translateY(-1px);
        }

        /* تحسينات التصميم المتجاوب */
        @media (max-width: 1024px) {
            .container {
                margin: 10px;
                border-radius: var(--border-radius-small);
            }

            .header {
                padding: 30px 20px;
            }

            .search-section {
                padding: 30px 20px;
            }

            .results-section {
                padding: 30px 20px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .search-container {
                flex-direction: column;
                gap: 15px;
            }

            .search-input {
                border-radius: var(--border-radius);
            }

            .search-btn {
                border-radius: var(--border-radius);
                padding: 15px 25px;
            }

            .results-table {
                font-size: 14px;
            }

            .results-table th,
            .results-table td {
                padding: 15px 10px;
            }

            .verse-text {
                font-size: 16px;
                line-height: 1.8;
            }

            .translation-cell {
                font-size: 12px;
                padding: 15px 8px !important;
            }

            .pagination-controls {
                flex-direction: column;
                gap: 10px;
            }

            .pagination-btn {
                min-width: 200px;
                padding: 15px 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .search-section {
                padding: 20px 15px;
            }

            .results-section {
                padding: 20px 15px;
            }

            .results-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .verse-text {
                font-size: 15px;
                white-space: normal;
            }
        }

        /* أنماط عناصر التحكم المحسنة */
        .search-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            flex-wrap: wrap;
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* تصميم Toggle Switch محسن */
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .toggle-input {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--text-light);
            border-radius: 24px;
            transition: var(--transition-medium);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: var(--transition-medium);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-input:checked + .toggle-slider {
            background: var(--success-color);
        }

        .toggle-input:checked + .toggle-slider::before {
            transform: translateX(26px);
        }

        .toggle-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* تصميم الأزرار المحسن */
        .control-btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 13px;
            font-weight: 500;
            font-family: 'Noto Sans Arabic', sans-serif;
            cursor: pointer;
            transition: var(--transition-medium);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-light);
        }

        .clear-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
            color: white;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-icon {
            font-size: 14px;
        }

        /* تصميم Select محسن */
        .select-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .control-select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            font-family: 'Noto Sans Arabic', sans-serif;
            background: white;
            cursor: pointer;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-light);
        }

        .control-select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        @media (max-width: 768px) {
            .search-controls {
                flex-direction: column;
                gap: 20px;
                padding: 20px 15px;
            }

            .control-group {
                width: 100%;
                justify-content: center;
            }

            .toggle-label {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>البحث في القرآن الكريم</h1>
            <p>ابحث عن أي كلمة أو جملة في كتاب الله العزيز</p>
            <p style="font-size: 14px; opacity: 0.8;">قاعدة بيانات محلية (عينة تجريبية)</p>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="أدخل الكلمة أو الجملة المراد البحث عنها...">
                <button id="searchBtn" class="search-btn">بحث</button>
            </div>

            <div class="search-controls">
                <div class="control-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="translationsToggle" checked class="toggle-input">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">تفعيل الترجمات الفرنسية</span>
                    </label>
                </div>

                <div class="control-group">
                    <button id="clearCacheBtn" class="control-btn clear-btn">
                        <span class="btn-icon">🗑️</span>
                        مسح التخزين المؤقت
                    </button>
                </div>

                <div class="control-group">
                    <label class="select-label">
                        النتائج لكل صفحة:
                        <select id="resultsPerPageSelect" class="control-select">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>

        <div class="results-section">
            <div id="loadingDiv" class="loading" style="display: none;">
                <div class="spinner"></div>
                جاري البحث...
            </div>

            <div id="errorDiv" style="display: none;"></div>

            <div id="resultsDiv" style="display: none;">
                <div id="resultsInfo" style="text-align: center; margin-bottom: 20px; color: #2c3e50; font-weight: bold;"></div>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">الآية القرآنية</th>
                            <th style="width: 20%;">محمد حميد الله</th>
                            <th style="width: 20%;">رشيد معاش</th>
                            <th style="width: 20%;">محمد نبيل رضوان</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>

                <div id="paginationDiv" style="display: none; text-align: center; margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <span id="pageInfo" style="color: #2c3e50; font-weight: bold;"></span>
                    </div>

                    <div class="pagination-controls">
                        <button id="firstPageBtn" class="pagination-btn">الصفحة الأولى</button>
                        <button id="prevPageBtn" class="pagination-btn">السابق</button>
                        <span id="currentPageDisplay" style="margin: 0 15px; color: #2c3e50; font-weight: bold;"></span>
                        <button id="nextPageBtn" class="pagination-btn">التالي</button>
                        <button id="lastPageBtn" class="pagination-btn">الصفحة الأخيرة</button>
                    </div>
                </div>
            </div>

            <div id="noResultsDiv" class="no-results" style="display: none;">
                لم يتم العثور على نتائج للبحث المطلوب
            </div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const loadingDiv = document.getElementById('loadingDiv');
        const errorDiv = document.getElementById('errorDiv');
        const resultsDiv = document.getElementById('resultsDiv');
        const noResultsDiv = document.getElementById('noResultsDiv');
        const resultsTableBody = document.getElementById('resultsTableBody');

        // البحث عند الضغط على Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // البحث عند الضغط على زر البحث
        searchBtn.addEventListener('click', performSearch);

        // معالج تفعيل/تعطيل الترجمات
        const translationsToggle = document.getElementById('translationsToggle');
        translationsToggle.addEventListener('change', function() {
            translationsEnabled = this.checked;
            console.log('الترجمات', translationsEnabled ? 'مفعلة' : 'معطلة');
        });

        // معالج مسح التخزين المؤقت
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        clearCacheBtn.addEventListener('click', function() {
            translationCache.clear();
            currentTranslationRequests.clear();
            console.log('تم مسح التخزين المؤقت للترجمات');
            alert('تم مسح التخزين المؤقت للترجمات');
        });

        // معالج تغيير عدد النتائج لكل صفحة
        const resultsPerPageSelect = document.getElementById('resultsPerPageSelect');
        resultsPerPageSelect.addEventListener('change', function() {
            resultsPerPage = parseInt(this.value);
            currentPage = 1;
            if (allSearchResults.length > 0) {
                displayPaginatedResults();
            }
        });

        // معالجات أزرار التنقل
        document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
        document.getElementById('prevPageBtn').addEventListener('click', () => goToPage(currentPage - 1));
        document.getElementById('nextPageBtn').addEventListener('click', () => goToPage(currentPage + 1));
        document.getElementById('lastPageBtn').addEventListener('click', () => goToPage(totalPages));



        // متغيرات عامة لتخزين بيانات القرآن
        let quranData = [];
        let isDataLoaded = false;

        // متغيرات الترجمات
        let translationsEnabled = true;
        let translationCache = new Map();
        let currentTranslationRequests = new Map();

        // مفاتيح الترجمات الفرنسية
        const translationKeys = {
            french_hameedullah: 'محمد حميد الله',
            french_rashid: 'رشيد معاش',
            french_montada: 'محمد نبيل رضوان'
        };

        // متغيرات نظام الصفحات
        let allSearchResults = [];
        let currentPage = 1;
        let resultsPerPage = 5;
        let totalPages = 0;

        // أسماء السور مرتبة حسب الرقم
        const suraNames = [
            'الفاتحة', 'البقرة', 'آل عمران', 'النساء', 'المائدة', 'الأنعام', 'الأعراف', 'الأنفال', 'التوبة', 'يونس',
            'هود', 'يوسف', 'الرعد', 'إبراهيم', 'الحجر', 'النحل', 'الإسراء', 'الكهف', 'مريم', 'طه',
            'الأنبياء', 'الحج', 'المؤمنون', 'النور', 'الفرقان', 'الشعراء', 'النمل', 'القصص', 'العنكبوت', 'الروم',
            'لقمان', 'السجدة', 'الأحزاب', 'سبأ', 'فاطر', 'يس', 'الصافات', 'ص', 'الزمر', 'غافر',
            'فصلت', 'الشورى', 'الزخرف', 'الدخان', 'الجاثية', 'الأحقاف', 'محمد', 'الفتح', 'الحجرات', 'ق',
            'الذاريات', 'الطور', 'النجم', 'القمر', 'الرحمن', 'الواقعة', 'الحديد', 'المجادلة', 'الحشر', 'الممتحنة',
            'الصف', 'الجمعة', 'المنافقون', 'التغابن', 'الطلاق', 'التحريم', 'الملك', 'القلم', 'الحاقة', 'المعارج',
            'نوح', 'الجن', 'المزمل', 'المدثر', 'القيامة', 'الإنسان', 'المرسلات', 'النبأ', 'النازعات', 'عبس',
            'التكوير', 'الانفطار', 'المطففين', 'الانشقاق', 'البروج', 'الطارق', 'الأعلى', 'الغاشية', 'الفجر', 'البلد',
            'الشمس', 'الليل', 'الضحى', 'الشرح', 'التين', 'العلق', 'القدر', 'البينة', 'الزلزلة', 'العاديات',
            'القارعة', 'التكاثر', 'العصر', 'الهمزة', 'الفيل', 'قريش', 'الماعون', 'الكوثر', 'الكافرون', 'النصر',
            'المسد', 'الإخلاص', 'الفلق', 'الناس'
        ];

        // بيانات القرآن المضمنة (عينة للاختبار)
        const embeddedQuranData = [
            [1,1,1,1,"بسم الله الرحمن الرحيم"],
            [2,1,1,2,"الحمد لله رب العالمين"],
            [3,1,1,3,"الرحمن الرحيم"],
            [4,1,1,4,"مالك يوم الدين"],
            [5,1,1,5,"إياك نعبد وإياك نستعين"],
            [6,1,1,6,"اهدنا الصراط المستقيم"],
            [7,1,1,7,"صراط الذين أنعمت عليهم غير المغضوب عليهم ولا الضالين"],
            [8,2,2,1,"الم"],
            [9,2,2,2,"ذلك الكتاب لا ريب فيه هدى للمتقين"],
            [10,2,2,3,"الذين يؤمنون بالغيب ويقيمون الصلاة ومما رزقناهم ينفقون"],
            [15,3,2,8,"ومن الناس من يقول آمنا بالله وباليوم الآخر وما هم بمؤمنين"],
            [16,3,2,9,"يخادعون الله والذين آمنوا وما يخدعون إلا أنفسهم وما يشعرون"],
            [22,3,2,15,"الله يستهزئ بهم ويمدهم في طغيانهم يعمهون"],
            [26,4,2,19,"أو كصيب من السماء فيه ظلمات ورعد وبرق يجعلون أصابعهم في آذانهم من الصواعق حذر الموت والله محيط بالكافرين"],
            [27,4,2,20,"يكاد البرق يخطف أبصارهم كلما أضاء لهم مشوا فيه وإذا أظلم عليهم قاموا ولو شاء الله لذهب بسمعهم وأبصارهم إن الله على كل شيء قدير"],
            [29,4,2,22,"الذي جعل لكم الأرض فراشا والسماء بناء وأنزل من السماء ماء فأخرج به من الثمرات رزقا لكم فلا تجعلوا لله أندادا وأنتم تعلمون"],
            [35,5,2,28,"كيف تكفرون بالله وكنتم أمواتا فأحياكم ثم يميتكم ثم يحييكم ثم إليه ترجعون"],
            [36,5,2,29,"هو الذي خلق لكم ما في الأرض جميعا ثم استوى إلى السماء فسواهن سبع سموات وهو بكل شيء عليم"],
            [62,8,2,55,"وإذ قلتم ياموسى لن نؤمن لك حتى نرى الله جهرة فأخذتكم الصاعقة وأنتم تنظرون"],
            [81,11,2,74,"ثم قست قلوبكم من بعد ذلك فهي كالحجارة أو أشد قسوة وإن من الحجارة لما يتفجر منه الأنهار وإن منها لما يشقق فيخرج منه الماء وإن منها لما يهبط من خشية الله وما الله بغافل عما تعملون"],
            [170,24,2,163,"وإلهكم إله واحد لا إله إلا هو الرحمن الرحيم"],
            [262,42,2,255,"الله لا إله إلا هو الحي القيوم لا تأخذه سنة ولا نوم له ما في السموات وما في الأرض من ذا الذي يشفع عنده إلا بإذنه يعلم ما بين أيديهم وما خلفهم ولا يحيطون بشيء من علمه إلا بما شاء وسع كرسيه السموات والأرض ولا يئوده حفظهما وهو العلي العظيم"],
            [295,50,3,2,"الله لا إله إلا هو الحي القيوم"],
            [6231,604,114,1,"قل أعوذ برب الناس"],
            [6232,604,114,2,"ملك الناس"],
            [6233,604,114,3,"إله الناس"],
            [6234,604,114,4,"من شر الوسواس الخناس"],
            [6235,604,114,5,"الذي يوسوس في صدور الناس"],
            [6236,604,114,6,"من الجنة والناس"]
        ];

        // تحميل بيانات القرآن من ملف CSV أو البيانات المضمنة
        async function loadQuranData() {
            if (isDataLoaded) return true;

            try {
                // محاولة تحميل من ملف CSV أولاً
                try {
                    const response = await fetch('orthographic_v1.0.csv');
                    if (response.ok) {
                        const csvText = await response.text();
                        const lines = csvText.trim().split('\n');

                        quranData = lines.map(line => {
                            // تحليل CSV بطريقة أكثر دقة للتعامل مع الفواصل في النص
                            const parts = line.split(',');
                            const serialNumber = parseInt(parts[0]);
                            const pageNumber = parseInt(parts[1]);
                            const suraNumber = parseInt(parts[2]);
                            const ayahNumber = parseInt(parts[3]);
                            // النص هو كل ما تبقى بعد الأعمدة الأربعة الأولى
                            const ayahText = parts.slice(4).join(',');

                            return {
                                serialNumber: serialNumber,
                                pageNumber: pageNumber,
                                suraNumber: suraNumber,
                                ayahNumber: ayahNumber,
                                ayahText: ayahText,
                                suraName: suraNames[suraNumber - 1] || `سورة ${suraNumber}`
                            };
                        });

                        console.log(`تم تحميل ${quranData.length} آية من ملف CSV`);
                    } else {
                        throw new Error('ملف CSV غير متاح');
                    }
                } catch (csvError) {
                    console.warn('لا يمكن تحميل ملف CSV، استخدام البيانات المضمنة:', csvError.message);

                    // استخدام البيانات المضمنة
                    quranData = embeddedQuranData.map(row => ({
                        serialNumber: row[0],
                        pageNumber: row[1],
                        suraNumber: row[2],
                        ayahNumber: row[3],
                        ayahText: row[4],
                        suraName: suraNames[row[2] - 1] || `سورة ${row[2]}`
                    }));

                    console.log(`تم تحميل ${quranData.length} آية من البيانات المضمنة`);
                }

                isDataLoaded = true;
                return true;

            } catch (error) {
                console.error('خطأ في تحميل بيانات القرآن:', error);
                throw new Error('فشل في تحميل بيانات القرآن الكريم');
            }
        }

        // البحث في بيانات القرآن المحلية
        function searchInQuran(searchTerm) {
            if (!isDataLoaded || quranData.length === 0) {
                throw new Error('بيانات القرآن غير محملة');
            }

            // تنظيف وتطبيع نص البحث
            const normalizedSearchTerm = searchTerm
                .toLowerCase()
                .trim()
                // إزالة التشكيل للبحث الأفضل
                .replace(/[\u064B-\u0652\u0670\u0640]/g, '');

            if (normalizedSearchTerm.length === 0) {
                return [];
            }

            const results = quranData.filter(ayah => {
                // تطبيع نص الآية للمقارنة
                const normalizedAyahText = ayah.ayahText
                    .toLowerCase()
                    .replace(/[\u064B-\u0652\u0670\u0640]/g, '');

                // البحث الجزئي غير الحساس للحالة
                return normalizedAyahText.includes(normalizedSearchTerm);
            });

            // ترتيب النتائج حسب الرقم التسلسلي
            results.sort((a, b) => a.serialNumber - b.serialNumber);

            // إرجاع البيانات الكاملة بدلاً من النص المنسق فقط
            return results.map(ayah => ({
                originalData: ayah,
                formattedText: `﴿${ayah.ayahText}﴾ [${ayah.suraName}: ${ayah.ayahNumber}]`
            }));
        }

        async function performSearch() {
            const searchTerm = searchInput.value.trim();

            if (!searchTerm) {
                alert('يرجى إدخال كلمة أو جملة للبحث');
                return;
            }

            // إخفاء النتائج السابقة وإظهار التحميل
            hideAllResults();
            loadingDiv.style.display = 'block';
            searchBtn.disabled = true;

            try {
                // تحميل بيانات القرآن إذا لم تكن محملة
                if (!isDataLoaded) {
                    // تحديث رسالة التحميل
                    loadingDiv.innerHTML = '<div class="spinner"></div>جاري تحميل بيانات القرآن الكريم...';
                    await loadQuranData();
                    loadingDiv.innerHTML = '<div class="spinner"></div>جاري البحث...';
                }

                // البحث في البيانات المحلية
                const results = searchInQuran(searchTerm);

                loadingDiv.style.display = 'none';
                searchBtn.disabled = false;

                if (results.length > 0) {
                    // حفظ جميع النتائج
                    allSearchResults = results;
                    currentPage = 1;

                    // عرض النتائج مع نظام الصفحات
                    displayPaginatedResults();
                } else {
                    noResultsDiv.style.display = 'block';
                }

            } catch (error) {
                loadingDiv.style.display = 'none';
                searchBtn.disabled = false;
                showError(`حدث خطأ أثناء البحث: ${error.message}`);
                console.error('Search error:', error);
            }
        }



        // جلب ترجمة واحدة من API مع تحسينات
        async function fetchSingleTranslation(translationKey, suraNumber, ayahNumber, retryCount = 0) {
            const cacheKey = `${translationKey}_${suraNumber}_${ayahNumber}`;

            // التحقق من التخزين المؤقت
            if (translationCache.has(cacheKey)) {
                console.log(`✅ استخدام الترجمة المحفوظة: ${translationKey} ${suraNumber}:${ayahNumber}`);
                return translationCache.get(cacheKey);
            }

            // التحقق من الطلبات الجارية
            if (currentTranslationRequests.has(cacheKey)) {
                console.log(`⏳ انتظار الطلب الجاري: ${translationKey} ${suraNumber}:${ayahNumber}`);
                return currentTranslationRequests.get(cacheKey);
            }

            const url = `https://quranenc.com/api/v1/translation/aya/${translationKey}/${suraNumber}/${ayahNumber}`;
            console.log(`🌐 جلب ترجمة جديدة (محاولة ${retryCount + 1}): ${url}`);

            // إنشاء AbortController للتحكم في timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 ثواني timeout

            const translationPromise = fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                    // إزالة Content-Type لأنه غير مطلوب في GET requests
                },
                signal: controller.signal
                // إزالة mode: 'cors' للسماح للمتصفح بالتعامل مع CORS تلقائياً
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log(`📡 استجابة API ${translationKey}: ${response.status} ${response.statusText}`);

                    if (!response.ok) {
                        throw new Error(`HTTP_${response.status}_${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`📖 بيانات الترجمة ${translationKey}:`, data);

                    // استخراج الترجمة من البيانات
                    let translation = 'غير متاح';
                    if (data.result && data.result.translation) {
                        translation = data.result.translation;
                    } else if (data.translation) {
                        translation = data.translation;
                    } else if (data.text) {
                        translation = data.text;
                    }

                    // حفظ في التخزين المؤقت
                    translationCache.set(cacheKey, translation);
                    currentTranslationRequests.delete(cacheKey);
                    console.log(`✅ تم حفظ الترجمة: ${translationKey} ${suraNumber}:${ayahNumber}`);
                    return translation;
                })
                .catch(async (error) => {
                    clearTimeout(timeoutId);
                    currentTranslationRequests.delete(cacheKey);

                    console.error(`❌ خطأ في جلب الترجمة ${translationKey} ${suraNumber}:${ayahNumber}:`, error);

                    // تحديد نوع الخطأ
                    let errorMessage = 'خطأ غير معروف';

                    if (error.name === 'AbortError') {
                        errorMessage = 'انتهت مهلة الطلب';
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        errorMessage = 'خطأ شبكة';
                    } else if (error.message.includes('CORS')) {
                        errorMessage = 'خطأ CORS';
                    } else if (error.message.includes('HTTP_404')) {
                        errorMessage = 'ترجمة غير موجودة';
                    } else if (error.message.includes('HTTP_500')) {
                        errorMessage = 'خطأ في الخادم';
                    } else if (error.message.includes('HTTP_')) {
                        errorMessage = `خطأ HTTP: ${error.message.split('_')[1]}`;
                    } else {
                        errorMessage = error.message;
                    }

                    // إعادة المحاولة للأخطاء المؤقتة
                    if (retryCount < 2 && (
                        error.name === 'AbortError' ||
                        error.message.includes('Failed to fetch') ||
                        error.message.includes('HTTP_5')
                    )) {
                        console.log(`🔄 إعادة المحاولة ${retryCount + 1} للترجمة ${translationKey}`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // تأخير متزايد
                        return fetchSingleTranslation(translationKey, suraNumber, ayahNumber, retryCount + 1);
                    }

                    return `❌ ${errorMessage}`;
                });

            currentTranslationRequests.set(cacheKey, translationPromise);
            return translationPromise;
        }

        // جلب جميع الترجمات لآية واحدة
        async function fetchAllTranslations(suraNumber, ayahNumber) {
            const translations = {};

            try {
                const promises = Object.keys(translationKeys).map(async (key) => {
                    const translation = await fetchSingleTranslation(key, suraNumber, ayahNumber);
                    translations[key] = translation;
                });

                await Promise.all(promises);
                return translations;
            } catch (error) {
                console.error('خطأ في جلب الترجمات:', error);
                return {
                    french_hameedullah: 'خطأ في التحميل',
                    french_rashid: 'خطأ في التحميل',
                    french_montada: 'خطأ في التحميل'
                };
            }
        }

        // تحديث خلية ترجمة في الجدول مع مؤشرات حالة محسنة
        function updateTranslationCell(row, columnIndex, translation, translationName) {
            const cell = row.cells[columnIndex];
            if (!cell) return;

            // إزالة الفئات السابقة
            cell.classList.remove('loading', 'error', 'success', 'warning', 'retry-available');

            if (translation.includes('⏳') || translation.includes('جاري التحميل')) {
                cell.classList.add('loading');
                cell.innerHTML = `<div class="loading-spinner" style="color: #007bff;">${translation}</div>`;
            } else if (translation.includes('❌') || translation.includes('خطأ شبكة') || translation.includes('خطأ CORS') || translation.includes('انتهت مهلة')) {
                cell.classList.add('error', 'retry-available');
                cell.innerHTML = `
                    <div class="translation-error" style="color: #dc3545; cursor: pointer;"
                         onclick="retryTranslation(this, ${columnIndex})"
                         title="اضغط لإعادة المحاولة">
                        ${translation} 🔄
                    </div>`;
            } else if (translation === 'غير متاح' || translation === 'ترجمة غير موجودة') {
                cell.classList.add('warning');
                cell.innerHTML = `<div class="translation-unavailable" style="color: #ffc107;">⚠️ ${translation}</div>`;
            } else if (translation === 'خطأ في التحميل') {
                cell.classList.add('error');
                cell.innerHTML = `<div class="translation-error" style="color: #dc3545;">${translation}</div>`;
            } else {
                cell.classList.add('success');
                cell.innerHTML = `<div class="translation-text">${translation}</div>`;
            }

            cell.title = `${translationName}: ${translation}`;
        }

        // عرض النتائج مع نظام الصفحات
        function displayPaginatedResults() {
            // حساب إجمالي الصفحات
            totalPages = Math.ceil(allSearchResults.length / resultsPerPage);

            // التأكد من أن الصفحة الحالية صحيحة
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            // حساب النتائج للصفحة الحالية
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const currentPageResults = allSearchResults.slice(startIndex, endIndex);

            // عرض النتائج
            displayResults(currentPageResults);

            // تحديث معلومات الصفحات
            updatePaginationInfo();

            // إظهار أزرار التنقل
            document.getElementById('paginationDiv').style.display = totalPages > 1 ? 'block' : 'none';
        }

        function displayResults(results) {
            resultsTableBody.innerHTML = '';

            results.forEach((resultItem, index) => {
                const row = document.createElement('tr');

                // إضافة البيانات الأصلية كخاصية في الصف للوصول إليها لاحقاً
                row.dataset.suraNumber = resultItem.originalData.suraNumber;
                row.dataset.ayahNumber = resultItem.originalData.ayahNumber;
                row.dataset.serialNumber = resultItem.originalData.serialNumber;

                row.innerHTML = `
                    <td class="verse-text">${resultItem.formattedText}</td>
                    <td class="translation-cell"><div class="loading-spinner">⏳ جاري التحميل...</div></td>
                    <td class="translation-cell"><div class="loading-spinner">⏳ جاري التحميل...</div></td>
                    <td class="translation-cell"><div class="loading-spinner">⏳ جاري التحميل...</div></td>
                `;
                resultsTableBody.appendChild(row);

                // جلب الترجمات إذا كانت مفعلة
                if (translationsEnabled) {
                    loadTranslationsForVerse(resultItem.originalData, row, index);
                }
            });

            resultsDiv.style.display = 'block';
        }

        // تحديث معلومات الصفحات
        function updatePaginationInfo() {
            const resultsInfo = document.getElementById('resultsInfo');
            const pageInfo = document.getElementById('pageInfo');
            const currentPageDisplay = document.getElementById('currentPageDisplay');

            // معلومات النتائج الإجمالية
            let infoText = `تم العثور على ${allSearchResults.length} آية`;
            if (resultsPerPage < allSearchResults.length) {
                const startResult = (currentPage - 1) * resultsPerPage + 1;
                const endResult = Math.min(currentPage * resultsPerPage, allSearchResults.length);
                infoText += ` - عرض ${startResult}-${endResult}`;
            }
            if (translationsEnabled) {
                infoText += ` - جاري تحميل الترجمات الفرنسية...`;
            }
            resultsInfo.textContent = infoText;

            // معلومات الصفحة
            pageInfo.textContent = `الصفحة ${currentPage} من ${totalPages}`;
            currentPageDisplay.textContent = `${currentPage} / ${totalPages}`;

            // تحديث حالة الأزرار
            updatePaginationButtons();
        }

        // تحديث حالة أزرار التنقل
        function updatePaginationButtons() {
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
        }

        // الانتقال لصفحة محددة
        function goToPage(pageNumber) {
            if (pageNumber >= 1 && pageNumber <= totalPages && pageNumber !== currentPage) {
                currentPage = pageNumber;
                displayPaginatedResults();
            }
        }

        // تحميل الترجمات لآية واحدة
        async function loadTranslationsForVerse(ayahData, row, index) {
            try {
                // التحقق من صحة البيانات المستخرجة
                if (!ayahData || !ayahData.suraNumber || !ayahData.ayahNumber) {
                    console.error('بيانات الآية غير صحيحة:', ayahData);
                    updateAllTranslationCells(row, 'بيانات غير صحيحة');
                    return;
                }

                const suraNumber = parseInt(ayahData.suraNumber);
                const ayahNumber = parseInt(ayahData.ayahNumber);

                // التحقق من صحة الأرقام
                if (isNaN(suraNumber) || isNaN(ayahNumber) || suraNumber < 1 || suraNumber > 114 || ayahNumber < 1) {
                    console.error('أرقام السورة أو الآية غير صحيحة:', { suraNumber, ayahNumber });
                    updateAllTranslationCells(row, 'أرقام غير صحيحة');
                    return;
                }

                console.log(`جلب الترجمات للسورة ${suraNumber} الآية ${ayahNumber} (${ayahData.suraName})`);

                // جلب الترجمات باستخدام البيانات المستخرجة مباشرة
                const translations = await fetchAllTranslations(suraNumber, ayahNumber);

                // تحديث الخلايا
                updateTranslationCell(row, 1, translations.french_hameedullah, translationKeys.french_hameedullah);
                updateTranslationCell(row, 2, translations.french_rashid, translationKeys.french_rashid);
                updateTranslationCell(row, 3, translations.french_montada, translationKeys.french_montada);

                console.log(`تم تحميل الترجمات بنجاح للسورة ${suraNumber} الآية ${ayahNumber}`);

            } catch (error) {
                console.error('خطأ في تحميل الترجمات للآية:', error);
                updateAllTranslationCells(row, 'خطأ في التحميل');
            }
        }

        // إعادة محاولة ترجمة واحدة
        async function retryTranslation(element, columnIndex) {
            const cell = element.closest('td');
            const row = cell.closest('tr');

            // استخراج معلومات الآية من dataset
            const suraNumber = parseInt(row.dataset.suraNumber);
            const ayahNumber = parseInt(row.dataset.ayahNumber);

            if (isNaN(suraNumber) || isNaN(ayahNumber)) {
                console.error('لا يمكن استخراج معلومات الآية للإعادة');
                return;
            }

            const translationKey = Object.keys(translationKeys)[columnIndex - 1];
            const translationName = Object.values(translationKeys)[columnIndex - 1];

            if (!translationKey) {
                console.error('مفتاح الترجمة غير صحيح:', columnIndex);
                return;
            }

            // إظهار حالة التحميل
            updateTranslationCell(row, columnIndex, '⏳ جاري إعادة المحاولة...', translationName);

            try {
                // مسح التخزين المؤقت لهذه الترجمة
                const cacheKey = `${translationKey}_${suraNumber}_${ayahNumber}`;
                translationCache.delete(cacheKey);
                currentTranslationRequests.delete(cacheKey);

                console.log(`🔄 إعادة محاولة جلب الترجمة: ${translationKey} ${suraNumber}:${ayahNumber}`);

                // جلب الترجمة مرة أخرى
                const translation = await fetchSingleTranslation(translationKey, suraNumber, ayahNumber);
                updateTranslationCell(row, columnIndex, translation, translationName);

            } catch (error) {
                console.error('خطأ في إعادة المحاولة:', error);
                updateTranslationCell(row, columnIndex, `❌ فشل في إعادة المحاولة`, translationName);
            }
        }

        // استخراج بيانات الآية من الصف (وظيفة مساعدة)
        function extractAyahDataFromRow(row) {
            return {
                suraNumber: parseInt(row.dataset.suraNumber),
                ayahNumber: parseInt(row.dataset.ayahNumber),
                serialNumber: parseInt(row.dataset.serialNumber)
            };
        }

        // تحديث جميع خلايا الترجمة برسالة واحدة
        function updateAllTranslationCells(row, message) {
            for (let i = 1; i <= 3; i++) {
                const translationName = Object.values(translationKeys)[i - 1];
                updateTranslationCell(row, i, message, translationName);
            }
        }

        function hideAllResults() {
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            noResultsDiv.style.display = 'none';
        }

        function showError(message) {
            errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
